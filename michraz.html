<html lang="he" dir="rtl">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/ju/jq-3.3.1/jszip-2.5.0/dt-1.10.25/b-1.7.1/b-colvis-1.7.1/b-html5-1.7.1/cr-1.5.4/fh-3.1.9/sc-2.0.4/datatables.min.css"/>
     
    <script type="text/javascript" src="https://cdn.datatables.net/v/ju/jq-3.3.1/jszip-2.5.0/dt-1.10.25/b-1.7.1/b-colvis-1.7.1/b-html5-1.7.1/cr-1.5.4/fh-3.1.9/sc-2.0.4/datatables.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>        
<body class="dropzone">

    <form id="jsonFile" name="jsonFile" enctype="multipart/form-data" method="post" style="text-align: center;">

        <fieldset>
            <h2>העלה קובץ</h2>
            <input type='file' id='fileinput' value="בחר קובץ">
            <input type='button' id='btnLoad' value="טען" onclick='loadFile();'>
        </fieldset>
    </form>

    <div id="myTables"></div>
    <div id="buttons"></div>

    <script type="text/javascript">
        const tables = document.getElementById("myTables");


        Object.values = obj => Object.keys(obj).map(key => obj[key]);
        function loadFile() {
            var input, file, fr;

            if (typeof window.FileReader !== 'function') {
                alert("The file API isn't supported on this browser yet.");
                return;
            }

            input = document.getElementById('fileinput');
            if (!input) {
                alert("Um, couldn't find the fileinput element.");
            }
            else if (!input.files) {
                alert("This browser doesn't seem to support the `files` property of file inputs.");
            }
            else if (!input.files[0]) {
                alert("Please select a file before clicking 'Load'");
            }
            else {
                file = input.files[0];
                fr = new FileReader();
                fr.onload = receivedText;
                fr.readAsText(file);
            }

            function receivedText(e) {
                let lines = e.target.result;
                var michrazList = JSON.parse(lines);

                const tikList = [];
                let i = 0;
                for (let michraz of michrazList) {
                    for (const tik of michraz["Tik"]) {
                        for (const mpHatzaaotMitcham of tik["mpHatzaaotMitcham"]) {
                            const item = {
                                "#": ++i,
                                ...michraz,
                                ...michraz["MessageDetails"],
                                ...michraz["MichrazFullDocument"],
                                ...tik,
                                ...mpHatzaaotMitcham
                            };
                            for (key of Object.keys(item)) {
                                if (typeof item[key] === "object") {
                                    delete item[key];
                                }   
                            }
                            delete item["mpHatzaaotMitcham"];
                            delete item["Tik"];
                            delete item["GushHelka"];
                            tikList.push(item);
                        }
                    }
                }

                const toDelete = tikList[0];
                const toPrint = {};
                let last = false;
                for (const tik of tikList) {
                    for (const key of Object.keys(tik)) {
                        if (last && tik[key] !== last[key]) {
                            toPrint[key] = true;
                        }
                    }
                    last = tik;
                }
                console.log(toPrint);

                const table = document.createElement("table");
                tables.appendChild(table);

                const thead = document.createElement("thead");
                table.appendChild(thead);
                const header = document.createElement("tr");
                thead.appendChild(header);

                for (const item of Object.keys(toPrint)) {
                    const cell = document.createElement("th");
                    cell.textContent = item;
                    header.appendChild(cell);
                }

                const tbody = document.createElement("tbody");
                table.appendChild(tbody);

                for (let tik of tikList) {
                    const row = document.createElement("tr");
                    tbody.appendChild(row);
                    for (const key of Object.keys(toPrint)) {
                        const cell = document.createElement("td");
                        cell.textContent = tik[key];
                        row.appendChild(cell);
                    }
                }
                var datatable = $(table).DataTable( {
                    dom: 'Bfrtip',
                    buttons: [
                        'copy', 'csv', 'excel'
                    ]
                } );
                datatable.buttons().container().appendTo( $('.col-sm-6:eq(0)', datatable.table().container() ) );

                document.getElementById("jsonFile").remove();
            }
        }

var $dropzone = document.querySelector('.dropzone');
var input = document.getElementById('fileinput');

$dropzone.ondragover = function (e) { 
  e.preventDefault(); 
  this.classList.add('dragover');
};
$dropzone.ondragleave = function (e) { 
    e.preventDefault();
    this.classList.remove('dragover');
};
$dropzone.ondrop = function (e) {
    e.preventDefault();
    this.classList.remove('dragover');
    input.files = e.dataTransfer.files;
    loadFile();
}
    </script>

</body>

</html>